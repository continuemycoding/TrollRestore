name: Build

on:
  workflow_dispatch:
  push:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2022, macos-15-intel]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python --version
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --clean --name TrollRestore --copy-metadata=readchar --copy-metadata=pymobiledevice3 trollstore.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollRestore-${{ matrix.os }}
          path: dist/TrollRestore*
      
      - name: Create Gitee Release & Upload Assets
        shell: python
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: RemotePro
          GITEE_REPO: RemotePro
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.sha }}
          PYTHONIOENCODING: utf-8
        run: |
          import os
          import requests
          import glob
          import sys

          token = os.environ.get('GITEE_TOKEN')
          owner = os.environ.get('GITEE_OWNER')
          repo = os.environ.get('GITEE_REPO')
          release_name = os.environ.get('COMMIT_MESSAGE')
          tag_name = os.environ.get('COMMIT_SHA')[:7]
          
          files_pattern = "dist/TrollRestore*"
          
          body = f"发布版描述"

          create_url = f"https://gitee.com/api/v5/repos/{owner}/{repo}/releases"
          payload = {
              "access_token": token,
              "tag_name": tag_name,
              "name": release_name,
              "body": body,
              "target_commitish": "master",
              "prerelease": True
          }

          release_id = None

          try:
              print(f"Creating release for tag: {tag_name}...")
              resp = requests.post(create_url, data=payload)
              
              if resp.status_code == 201:
                  print("Release created successfully.")
                  release_id = resp.json()['id']
              else:
                  print(f"Create returned status {resp.status_code}. Response: {resp.text}")
                  print("Assuming release already exists. Trying to get its ID...")
                  
                  get_rel_url = f"https://gitee.com/api/v5/repos/{owner}/{repo}/releases/tags/{tag_name}"
                  get_resp = requests.get(get_rel_url, params={"access_token": token})
                  
                  if get_resp.status_code == 200:
                      release_id = get_resp.json()['id']
                      print(f"Found existing release ID: {release_id}")
                  else:
                      print(f"Failed to get existing release: {get_resp.text}")
                      # 如果既创建失败，又获取不到，那就是真出错了，抛出原始创建错误
                      resp.raise_for_status()

          except Exception as e:
              print(f"Critical error handling release: {e}")
              sys.exit(1)

          if not release_id:
              print("Failed to obtain Release ID.")
              sys.exit(1)

          upload_url = f"https://gitee.com/api/v5/repos/{owner}/{repo}/releases/{release_id}/attach_files"
          files_to_upload = glob.glob(files_pattern)

          if not files_to_upload:
              print(f"No files found for pattern: {files_pattern}")
          else:
              for file_path in files_to_upload:
                  filename = os.path.basename(file_path)
                  print(f"Uploading {filename}...")
                  try:
                      with open(file_path, 'rb') as f:
                          files = {'file': (filename, f)}
                          # 上传文件时，如果文件名重复 Gitee 也会报错，这里加一个 try-except 忽略重复上传错误
                          up_resp = requests.post(upload_url, params={'access_token': token}, files=files)
                          if up_resp.status_code == 201:
                              print(f"Uploaded {filename} success.")
                          else:
                              print(f"Upload {filename} response: {up_resp.text}")
                  except Exception as e:
                      print(f"Error uploading {filename}: {e}")
